# GenMinute 개발 일지 (Dev Log)

## 2025년 11월 30일 - 실시간 녹음 및 모바일 대응 기능 구현 (Phase 1)

### 1. 개요 (Overview)
기존 파일 업로드 방식의 한계를 극복하고, 대면 회의 및 Zoom 화상 회의를 즉시 기록할 수 있는 '유니버설 웹 레코더' 기능을 구현함. 또한 모바일 환경에서의 사용성을 개선하기 위해 UI/UX를 최적화함.

### 2. 주요 변경 사항 (Changes)

#### 📱 모바일 UI/UX 개선
*   **문제:** 모바일 접속 시 메뉴가 화면을 가리고, 챗봇 사이드바가 자동 개방되어 사용성 저해.
*   **해결:**
    *   `templates/layout.html`: 모바일 전용 헤더(햄버거 메뉴) 및 오버레이 추가.
    *   `static/css/style.css`: 반응형 미디어 쿼리(`max-width: 768px`) 적용. 사이드바 메뉴를 슬라이드 방식으로 변경.
    *   `static/js/script.js`: 모바일 환경 감지 시 챗봇 자동 열림 방지 로직 추가.

#### 🎙️ 실시간 녹음 기능 (GenMinute Live Phase 1)
*   **아키텍처 결정:** '에이전트 Tool' 방식 대신 **'웹앱 모듈 확장'** 방식을 채택하여 모바일 호환성과 OS 독립성 확보.
*   **신규 모듈:**
    *   `routes/live_record.py`: 녹음 페이지 라우팅 (`/record`).
    *   `templates/live/recorder.html`: 마이크/시스템 오디오 탭 기반 녹음 UI. 파형 시각화(Visualizer) 포함.
    *   `static/js/live/recorder.js`: 
        *   `getUserMedia`: 모바일/마이크 녹음.
        *   `getDisplayMedia`: PC 시스템 오디오(Zoom, Youtube 등) 캡처.
        *   녹음 종료 시 `Blob` 데이터를 생성하여 기존 `/upload` 파이프라인으로 전송 (백엔드 수정 최소화).
*   **연동:** 메인 네비게이션에 '실시간 녹음' 메뉴 추가.

### 3. 기술적 특징 (Technical Notes)
*   **시스템 오디오 캡처:** 별도의 드라이버 설치 없이 브라우저의 `getDisplayMedia` API를 활용하여 Zoom 회의 소리를 깨끗하게 녹음 가능.
*   **통합 파이프라인:** 녹음된 데이터는 기존 업로드 로직을 그대로 타므로, STT/요약/마인드맵 생성 등의 후처리 과정이 동일하게 적용됨.

### 4. 향후 계획 (Next Steps)
*   **Phase 2:** WebSocket(`Flask-SocketIO`)을 도입하여 녹음 중 실시간으로 텍스트가 변환되는 '준실시간 미리보기' 기능 구현 예정.

---

## 2025년 11월 30일 - 실시간 녹음/녹화 기능 디버깅 및 개선 (Phase 1 연장)

### 1. 개요 (Overview)
실시간 녹음/녹화 기능의 초기 테스트 과정에서 발생한 문제들을 분석하고 수정하여, 사용자 경험을 개선하고 시스템 안정성을 확보함. 특히 PC 시스템 오디오 캡처 시 비디오 트랙을 포함하여 녹화하는 기능을 추가하고, 서버-클라이언트 간의 에러 리포팅을 강화함.

### 2. 주요 변경 사항 (Changes)

#### 📝 블루프린트 임포트 버그 수정
*   **문제:** `routes/__init__.py`에서 `auth_bp`, `meetings_bp`, `chat_bp` 등 핵심 블루프린트 임포트 누락으로 서버 시작 시 오류 발생 가능성.
*   **해결:** `routes/__init__.py` 파일에 누락된 블루프린트 임포트 구문 추가하여 정상적인 라우트 등록 보장.

#### 📹 실시간 녹음/녹화 기능 개선 (프론트엔드 - `static/js/live/recorder.js`)
*   **PC 시스템 녹화 에러 해결:**
    *   **문제:** `getDisplayMedia`로 얻은 비디오+오디오 스트림을 오디오 전용 `mimeType`으로 `MediaRecorder.start()` 호출 시 `NotSupportedError` 발생.
    *   **해결:** `type`이 'mic'일 때는 오디오 전용 `mimeType`을, 'sys'일 때는 `video/webm`과 같은 비디오+오디오 `mimeType`을 사용하도록 `startRecording` 함수 수정. PC 시스템 녹화 시 `getDisplayMedia` 스트림을 그대로 `MediaRecorder`에 전달하여 비디오 녹화도 가능하도록 변경.
*   **업로드 후 리다이렉트 문제 해결:**
    *   **문제:** `/upload` API 호출 후 서버로부터 SSE 응답을 받지만, `redirect` 필드를 포함한 `complete` 메시지를 제대로 파싱하지 못해 "완료되었으나 이동할 주소를 찾지 못했습니다." 팝업 발생.
    *   **해결:** `fetch` 응답의 SSE 스트림을 파싱하는 로직을 강화하고, `complete` 메시지 수신 시 `redirectUrl`로 정확히 이동하도록 수정. 서버 연결 종료 시 발생하는 알림 메시지 로직을 보완.
*   **PC 시스템 녹화 시 영상 포함 기능 추가:**
    *   **요구사항:** PC 시스템 오디오 캡처 시 음성뿐만 아니라 영상도 함께 녹화하여 화상 회의 기록 기능 강화.
    *   **해결:** `MediaRecorder`의 `mimeType`을 비디오+오디오를 지원하는 `video/webm` 등으로 변경하고, 녹화 완료 후 미리보기 재생 시 `audio` 태그 대신 동적으로 생성된 `video` 태그를 사용하도록 수정.
*   **하이브리드 파일명 적용 (보안 강화 및 확장성 고려):**
    *   **문제:** 기존 파일명은 내용을 파악하기 어렵고, 제목을 그대로 쓰면 보안 위험과 확장성 문제가 있음.
    *   **해결:** `[prefix]_[날짜시간]_[제목].webm` 형식을 시도했으나, 보안과 향후 시리즈 관리 확장성을 고려하여 제목을 제외한 `[UUID]_[prefix]_[날짜시간].mp4` 형식을 최종 채택. 뷰어에서는 DB에 저장된 메타데이터(제목, 날짜)를 사용하여 정보를 표시하도록 설계.

#### 💾 백엔드 파일 처리 로직 보완 (`services/upload_service.py`, `config.py`)
*   **문제:** 프론트엔드에서 `.webm` 파일(특히 시스템 녹화 시 영상 포함)을 업로드해도, 백엔드의 `save_uploaded_file` 함수가 `.mp4`만 비디오로 인식하여 적절한 오디오 추출 로직(`convert_video_to_audio`)을 거치지 않음. 또한 `config.py`의 `ALLOWED_EXTENSIONS`에 `webm`이 누락되어 업로드 자체가 거부되는 문제 발견.
*   **해결:** `config.py`에 `webm` 확장자 허용 추가. `save_uploaded_file` 함수에서 `.webm` 확장자도 비디오 파일로 인식하도록 `is_video` 판단 로직을 확장.
*   **FFmpeg 상세 로깅 추가:** `convert_video_to_audio` 메서드 내 `subprocess.run` 호출 후 `stdout`과 `stderr` 내용을 로그로 출력하여 FFmpeg 실행 결과 디버깅 용이성 확보.
*   **자동 포맷 변환 및 호환성 확보 (표준화):**
    *   **문제:** 다양한 확장자(`.webm` 등)가 업로드되면 뷰어 호환성 문제가 발생할 수 있음.
    *   **해결:** `convert_webm_to_compatible_format` 메서드를 추가하여, 파일명 접두어(`video_`) 유무에 따라 `.webm` 파일을 호환성 높은 `.mp4` (비디오) 또는 `.m4a` (오디오)로 자동 변환하도록 구현.
*   **DB 저장 파일명 불일치 해결:**
    *   **문제:** DB에 최종 변환된 파일명(.mp4/.m4a)이 아닌 STT 임시 파일명(_converted.wav)이 저장되어 뷰어에서 404 오류 발생.
    *   **해결:** `process_audio_file` 메서드에 `original_filename` 인자를 추가하여, DB 저장 시 최종 변환된 파일명을 명시적으로 지정할 수 있도록 수정.

#### 🚨 서버 에러 리포팅 및 라우팅 강화 (`routes/meetings.py`)
*   **문제:** `/upload` API 처리 중 서버에서 예외가 발생하면 클라이언트에 구체적인 에러 메시지를 전달하지 않고 연결이 끊어져, 클라이언트에서 "서버 연결이 종료되었습니다."라는 모호한 메시지만 표시됨.
*   **해결:** `upload_and_process` 함수 내 `generate` 제너레이터의 `try-except` 블록을 수정하여, 예외 발생 시 로그만 출력하는 대신 클라이언트에 에러 정보가 담긴 JSON 메시지(SSE 형식)를 전송하도록 변경.
*   **자동 변환 로직 연결:** 업로드된 파일이 `.webm`인 경우, `upload_and_process` 함수 시작 부분에서 `upload_service.convert_webm_to_compatible_format`을 호출하여 표준 포맷(.mp4/.m4a)으로 변환 후 후속 처리를 진행하도록 수정.

#### 📺 뷰어 호환성 개선 (`static/js/viewer.js`)
*   **문제:** 뷰어가 파일명이나 확장자에 따라 비디오/오디오 플레이어를 선택하는데, `.webm` 파일에 대한 처리가 미흡하여 재생되지 않는 문제 발생.
*   **해결:** 서버에서 표준 포맷(`.mp4`, `.m4a`)으로 변환하여 저장하므로, 뷰어 로직을 단순화하여 `.mp4` 확장자일 경우 비디오 플레이어를, 그 외(`.m4a` 등)일 경우 오디오 플레이어를 사용하도록 수정. 이를 통해 모든 브라우저와 OS에서 완벽한 재생 호환성 확보.

### 3. 현재 상태 (Status)
*   **기능 동작 확인:** PC 환경에서 마이크 녹음 및 시스템 녹화(영상 포함) 기능이 정상 작동하며, 각각 음성만, 또는 영상과 음성이 함께 녹화됨.
*   **자동 변환 및 재생:** 녹화된 `.webm` 파일이 서버 업로드 후 자동으로 `.mp4` 또는 `.m4a`로 변환되며, 뷰어 페이지에서 적절한 플레이어(비디오/오디오)로 정상 재생됨을 확인.
*   **STT 및 요약:** Google Gemini를 이용한 STT 및 요약 생성, 회의록 생성 기능이 정상 작동함.
*   **에러 해결:** FFmpeg 경로 설정 문제 및 OpenAI API Quota Exceeded 문제(임베딩 생성 시 발생)를 확인하고 해결 방안(터미널 재시작, 결제 또는 Gemini 임베딩 전환)을 모색함.

### 4. 다음 계획 (Next Steps)
*   **Phase 2 (준실시간 미리보기):** WebSocket(`Flask-SocketIO`)을 도입하여 녹음 중 실시간으로 텍스트가 변환되는 기능 구현.
*   **파일 시스템 및 DB 구조 고도화 (중장기):**
    *   **보안 강화:** 파일명을 `[UUID].mp4` 형식으로 완전 난수화하여 물리적 파일명에서 민감 정보를 제거.
    *   **사용자 경험 개선:** 파일 다운로드 시 `Content-Disposition` 헤더를 활용하여 사용자가 지정한 제목(`날짜_제목.mp4`)으로 파일이 저장되도록 구현.
    *   **확장성 확보:** DB 스키마에 `series_id` 등을 추가하여, 파일명 의존 없이 DB 관계(Relation)를 통해 '시리즈 회의' 묶기 기능 구현.
*   **OpenAI API 이슈 해결 (보류):** 벡터 임베딩 생성 시 간헐적인 429 에러가 발생했으나 현재는 정상 작동 중이므로, 추후 Gemini 임베딩 모델로의 전환 등 근본적인 해결책을 적용할 예정.